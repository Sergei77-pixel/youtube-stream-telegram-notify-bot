# Бот уведомлений о трансляциях YouTube (aiogram)

Простой бот, который присылает уведомления в Telegram, когда выбранные каналы YouTube выходят в эфир. Управление ботом — только из личных сообщений. Можно указать дополнительные «назначения» (чаты/группы/каналы), куда слать уведомления.

- Язык бота: русский
- Несколько ключей YouTube API с автоматической ротацией при исчерпании квоты
- Кулдаун после обнаружения эфира, чтобы экономить квоту
- Хранение в JSON-файле (подходит для небольшого использования)

---

## Быстрый старт (Windows, PowerShell)

1) Установите Python 3.10+ с https://www.python.org/

2) Создайте бота у @BotFather в Telegram и получите токен `TELEGRAM_BOT_TOKEN`.
	 - Команда `/newbot` → имя → @username → получите токен.

3) Получите ключ YouTube Data API v3:
	 - https://console.cloud.google.com/
	 - Создайте проект → Включите API «YouTube Data API v3» → Создайте «API key».
	 - Можно сделать несколько ключей, чтобы бот автоматически переключался, когда один «закончился» по квоте.

4) Скопируйте файл `.env.example` в `.env` и заполните значения (см. примеры ниже).

5) Установите зависимости и запустите бота:
```powershell
python -m venv .venv
. .venv/Scripts/Activate.ps1
pip install -r requirements.txt
# (необязательно) укажем PYTHONPATH на текущую папку
$env:PYTHONPATH = (Get-Location)
python main.py
```

Остановить бота: нажмите Ctrl+C в окне PowerShell (вы увидите код выхода 130 — это нормально, означает прерывание).

---

## Установка на сервер Ubuntu (22.04/24.04)

Ниже — минимально необходимые шаги для развёртывания как systemd-сервиса.

1) Обновите систему и поставьте Python
```bash
sudo apt update
sudo apt install -y python3 python3-venv python3-pip git
python3 --version
```

2) Создайте пользователя для бота (по желанию)
```bash
sudo adduser --system --group --home /opt/youtube_notify youtube-bot
sudo mkdir -p /opt/youtube_notify
sudo chown -R youtube-bot:youtube-bot /opt/youtube_notify
```

3) Скопируйте код бота на сервер
- Вариант A (git):
```bash
sudo -u youtube-bot -H bash -lc "cd /opt/youtube_notify && git init && git remote add origin <ваш-репозиторий> && git fetch && git checkout -t origin/main"
```
- Вариант B (копирование файлов):
	Залейте содержимое проекта в `/opt/youtube_notify` (SCP/rsync/FTP) и убедитесь, что владелец — `youtube-bot`.

4) Подготовьте виртуальное окружение и зависимости
```bash
sudo -u youtube-bot -H bash -lc "cd /opt/youtube_notify && python3 -m venv .venv && . .venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt"
```

5) Создайте `.env`
```bash
sudo -u youtube-bot -H bash -lc "cd /opt/youtube_notify && cp .env.example .env && nano .env"
```
Заполните: `TELEGRAM_BOT_TOKEN`, `YT_API_KEY` или `YT_API_KEYS`, при необходимости — остальные параметры.

6) Проверьте запуск вручную
```bash
sudo -u youtube-bot -H bash -lc "cd /opt/youtube_notify && . .venv/bin/activate && python main.py"
```
Остановите `Ctrl+C` после проверки.

7) Настройте systemd-сервис
Создайте файл `/etc/systemd/system/youtube-notify.service` со следующим содержимым:
```ini
[Unit]
Description=YouTube Live Notifier Bot
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=youtube-bot
Group=youtube-bot
WorkingDirectory=/opt/youtube_notify
ExecStart=/opt/youtube_notify/.venv/bin/python /opt/youtube_notify/main.py
Restart=on-failure
RestartSec=5
# По желанию увеличьте лимит открытых файлов
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```
Загрузите сервис и включите автозапуск:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now youtube-notify.service
```

8) Логи и статус
```bash
sudo systemctl status youtube-notify.service
journalctl -u youtube-notify.service -f
```

9) Обновление кода
```bash
# если git
sudo -u youtube-bot -H bash -lc "cd /opt/youtube_notify && git pull && . .venv/bin/activate && pip install -r requirements.txt"
sudo systemctl restart youtube-notify.service
```

Подсказки:
- Если используете `YT_API_KEYS`, указывайте ключи через запятую или `;`.
- Для записи в группы/каналы убедитесь, что бот добавлен и имеет права отправки сообщений.

---

## Настройка .env

Минимум, что нужно указать — токен бота и хотя бы один ключ YouTube API.

- Один ключ:
```
TELEGRAM_BOT_TOKEN=123456:ABCDEF...
YT_API_KEY=AIzaSyA_example_single_key_12345
```

- Несколько ключей (бот будет переключаться между ними автоматически):
```
TELEGRAM_BOT_TOKEN=123456:ABCDEF...
YT_API_KEYS=AIzaSyA_key1_111,AIzaSyA_key2_222,AIzaSyA_key3_333
```
или так (через точку с запятой):
```
YT_API_KEYS=AIzaSyA_key1_111;AIzaSyA_key2_222;AIzaSyA_key3_333
```

Дополнительные параметры:
- `POLL_INTERVAL` — как часто проверять каналы (секунды), по умолчанию `120`.
- `STORAGE_PATH` — путь к JSON-хранилищу, по умолчанию `data/storage.json`.
- `ALLOWED_USER_IDS` — (необязательно) список ID пользователей Telegram, которым разрешено управлять ботом (через запятую или `;`). Пример: `ALLOWED_USER_IDS=12345,67890`.
- `COOLDOWN_SECONDS` — (необязательно) кулдаун для канала после обнаружения эфира, по умолчанию `3600`.

> Примечание: если указаны и `YT_API_KEY`, и `YT_API_KEYS`, используется список `YT_API_KEYS`.

---

## Как пользоваться (команды в ЛС боту)

- `/start` — приветствие и помощь.
- `/subscribe` или `/add` — добавить канал через мастер:
	1. Отправьте ссылку/ID/@хэндл канала YouTube (например, `https://youtube.com/@LinusTechTips`, `@LinusTechTips` или `UC...`).
	2. Затем укажите назначения (через пробел): `@username` / `t.me/username` / числовой ID чата.  
		 Можно отправить `skip` или `пропустить`, чтобы уведомления шли только в ваш личный чат.
- `/list` или `/show` — показать список каналов и куда для каждого идут уведомления.
- `/remove` или `/delete` — удалить канал по номеру из списка (бот покажет нумерованный список и попросит номер).
- `/cancel` — отменить текущее действие (также работает слово `отмена`).

### Пример сценария добавления
1. Вы: `/add https://youtube.com/@SomeChannel`
2. Бот: «Теперь отправьте назначения… Отправьте 'skip' или 'пропустить'…»
3. Вы: `@mygroup @mychannel`
4. Бот: «Следим за SomeChannel (UCxxxxxxxx…). Добавлены назначения: -100123456, -100987654»

> Важное: чтобы бот мог писать в группу/канал, он должен там быть участником (а в канале — иметь право публиковать сообщения, чаще всего — быть администратором).

---

## Где приходят уведомления
- Всегда — в ваш личный чат (с тем, кто настроил подписку).
- Плюс — во все указанные «назначения» (группы/каналы/чаты), где у бота есть права на отправку сообщений.
- Сообщение вида: `«Название канала в эфире: Название стрима»` + ссылка на эфир.

---

## Частые вопросы и проблемы
- Бот не пишет в канал/группу:
	- Проверьте, что бот добавлен в чат и у него есть права на отправку (в канале — чаще всего админ).
- «Канал не найден»:
	- Проверьте ссылку/хэндл/ID. Работают: `@handle`, `t.me/username` (для TG-назначений), `https://youtube.com/@handle` или `UC...` для YouTube.
- Исчерпана квота YouTube API:
	- Добавьте несколько ключей в `YT_API_KEYS` — бот будет переключаться автоматически.
- Уведомления не приходят:
	- Возможно, канал ещё не «live»; либо сработал кулдаун (`COOLDOWN_SECONDS`); либо бот не может писать в указанные назначения.

---

## Лимиты и квоты YouTube API (важно)

YouTube Data API v3 выдаёт суточную квоту в 10 000 единиц на ОДИН проект Google Cloud. Все ключи в рамках одного проекта ДЕЛЯТ эту квоту. Чтобы иметь несколько независимых квот по 10 000, используйте РАЗНЫЕ проекты. Многие делают разные проекты в одном аккаунте — это обычно достаточно. Некоторые предпочитают разные аккаунты Google для каждого проекта, чтобы ещё меньше шансов на «склейку» ограничений.

Что именно тратит квоту в этом боте:
- `search.list` (проверка «в эфире»): 100 единиц
- `videos.list` (детали видео/эфира): 1 единица
Итого одна проверка одного канала ≈ 101 единица.

Формула расхода в сутки:
```
расход = 101 × N_каналов × (86400 / POLL_INTERVAL)
```
Ограничение по ключам/проектам (K — количество независимых квот = число проектов):
```
расход ≤ 10 000 × K
⇒ минимальный интервал
POLL_INTERVAL ≥ (101 × N_каналов × 86400) / (10 000 × K)
```

Примеры (округляем в большую сторону):
- 1 ключ (K=1), 1 канал (N=1):
	- `POLL_INTERVAL ≥ (101×1×86400)/(10000×1) ≈ 873с` ≈ 15 минут
- 1 ключ, 5 каналов: `POLL_INTERVAL ≥ ~4366с` ≈ 73 минуты
- 1 ключ, 10 каналов: `POLL_INTERVAL ≥ ~8731с` ≈ 2 часа 26 минут
- 3 ключа (K=3), 20 каналов: `POLL_INTERVAL ≥ ~5818с` ≈ 1 час 37 минут

Рекомендации:
- Если 1–3 канала и 1 ключ: ставьте `POLL_INTERVAL=900–1200` (15–20 минут).
- Если 5–10 каналов и 1 ключ: `POLL_INTERVAL=3600–7200` (60–120 минут).
- Если есть 3 ключа (3 независимые квоты): можно делить интервал примерно на 3.
- Для надёжного запаса берите интервал на 10–20% больше расчётного.

Дополнительно:
- Кулдаун `COOLDOWN_SECONDS` уменьшает частые повторные проверки ПОСЛЕ обнаружения эфира, экономя квоту. Но пока канал не в эфире, расход идёт по формуле выше.
- Разовые команды в личке (`/add`, `/list`) тоже тратят немного квоты (например, `channels.list` — 1 единица), но это несопоставимо с регулярным опросом.

Итого: чтобы не упираться в лимиты, корректируйте `POLL_INTERVAL` исходя из числа каналов и количества независимых квот (проектов/ключей), а при необходимости добавляйте новые проекты с отдельной квотой и указывайте их ключи в `YT_API_KEYS`.

---

## Обновление и обслуживание
- Обновить зависимости:
```powershell
pip install -r requirements.txt --upgrade
```
- Запуск/останов:
	- Запуск: `python main.py`
	- Остановка: `Ctrl+C` (код выхода 130 — это нормально)

---

## Безопасность
- Не публикуйте файл `.env` и не делитесь токенами/ключами.
- Ограничьте доступ к управлению ботом через `ALLOWED_USER_IDS` при необходимости.
